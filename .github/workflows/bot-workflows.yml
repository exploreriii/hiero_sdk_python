name: PythonBot - Workflow Failure Notifier

on:
  workflow_run:
    workflows:
      - "PR Formatting"
    types:
      - completed
  workflow_dispatch:   # <-- Adds the manual "Run workflow" button

permissions:
  contents: read
  pull-requests: write

jobs:
  notify-pr:
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Get associated PR number
        id: get-pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Running manually. Set HEAD_BRANCH manually or via inputs."
            HEAD_BRANCH="${{ github.event.inputs.head_branch || 'bot-workflow' }}"
          else
            HEAD_BRANCH=$(gh run view ${{ github.event.workflow_run.id }} \
              --repo ${{ github.repository }} \
              --json headBranch --jq '.headBranch')
          fi

          PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --state all --head "$HEAD_BRANCH" --json number --jq '.[0].number')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

      - name: Comment on PR
        if: env.PR_NUMBER != ''
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          COMMENT="Hi, this is WorkflowBot. The PR Formatting workflow has failed for this pull request. Please review the logs to resolve issues and ensure all checks pass before merging."
          gh pr comment "$PR_NUMBER" --repo "$REPO" --body "$COMMENT"
